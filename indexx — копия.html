<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–†–∞–¥–∞—Ä –ü'—è—Ç–∏—Ö–∞—Ç–æ–∫</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.10.2/dist/geosearch.css" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        html,body,#map { height:100%; margin:0; padding:0; }
        body {
            background: #ffffff;
            font-family: "Montserrat", Arial, sans-serif;
            overflow: hidden;
        }

        .leaflet-container { background: #ffffff !important; }

        .toolbar {
            position: absolute; top: 16px; left: 16px; z-index: 1000;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
            padding: 20px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            font-size: 13px; color: #e2e8f0; max-width: 400px;
        }
        .toolbar.minimized { padding:12px 16px; }
        .toolbar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .toolbar-title { font-size:16px; font-weight:700; color:#60a5fa; }
        .toolbar-section { margin-bottom:12px; padding:12px; background: rgba(255,255,255,0.05); border-radius:8px; }
        .toolbar-section-title { font-size:11px; color:#94a3b8; margin-bottom:8px; font-weight:600; text-transform:uppercase; }
        .button-group { display:flex; gap:6px; flex-wrap:wrap; }

        button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; border:none; padding:8px 14px; border-radius:8px;
            font-family:"Montserrat", Arial, sans-serif; font-size:12px; font-weight:600; cursor:pointer;
            transition: all 0.2s ease; box-shadow:0 2px 8px rgba(59,130,246,0.3);
        }
        button.secondary { background: linear-gradient(135deg,#64748b 0%,#475569 100%); }
        button.success { background: linear-gradient(135deg,#10b981 0%,#059669 100%); }
        button.danger { background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%); }
        button.active-spawn { background: linear-gradient(135deg,#f97316 0%,#ea580c 100%); }

        input[type="number"], input[type="range"] { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#e2e8f0; padding:6px 10px; border-radius:6px; width:70px; }
        label { display:flex; align-items:center; gap:8px; color:#cbd5e1; font-size:12px; }

        .shakhed-icon{ width:25px; height:25px; }
        .razved-icon { width:24px; height:24px; }
        .raketa-icon { width:25px; height:25px; }
        .neizv-icon { width:32px; height:32px; }
        .istreb-icon { width:30px; height:30px; }
        
        /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è PNG –≤–∑—Ä—ã–≤–∞ */
        .explosion-icon { 
            width:50px; /* –ò–ó–ú–ï–ù–ï–ù–û: 70px -> 50px */
            height:50px; /* –ò–ó–ú–ï–ù–ï–ù–û: 70px -> 50px */
            background-image: url('explosion.png'); /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PNG */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: pulse 0.5s infinite alternate; 
        }

        @keyframes pulse {
            from { transform: scale(0.9); opacity: 1; }
            to { transform: scale(1.1); opacity: 0.8; }
        }

        .marker-wrap{ 
            position:relative; 
            width:50px; /* –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
            height:35px; 
            transform-origin:50% 50%; 
            transition: transform 0.1s ease; 
        }
        .marker-wrap[data-type="explosion"] { 
             width:50px; /* –ò–ó–ú–ï–ù–ï–ù–û: 70px -> 50px */
             height:50px; /* –ò–ó–ú–ï–ù–ï–ù–û: 70px -> 50px */
        }

        .marker-border{ position:absolute; left:0; top:0; right:0; bottom:0; border-radius:8px; pointer-events:auto; transition: all 0.2s ease; }
        .marker-selected .marker-border{ box-shadow:0 0 0 3px rgba(59,130,246,0.8), 0 0 20px rgba(59,130,246,0.5); background: rgba(59,130,246,0.1); }
        .rotate-handle{ position:absolute; width:14px; height:14px; border-radius:50%; right:-7px; top:50%; transform:translateY(-50%); background: rgba(59,130,246,0.8); border:2px solid white; cursor:grab; opacity:0; transition:opacity 0.2s ease; }
        .marker-selected .rotate-handle { opacity:1; }

        .marquee{ position:absolute; border:2px dashed #3b82f6; background: rgba(59,130,246,0.1); backdrop-filter: blur(4px); z-index:2000; pointer-events:none; border-radius:4px; }
        .watermark-grid {
            position: absolute;
            top:0; left:0;
            width:100%; height:100%;
            pointer-events:none;
            z-index:500;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            grid-auto-rows: 140px;
            justify-items: center;
            align-items: center;
            gap: 20px;
            padding: 40px;
        }

        .watermark-item {
            text-align: center;
            pointer-events:none;
            font-family: "Montserrat", Arial, sans-serif;
            line-height: 1.2;
            user-select: none;
            -webkit-user-select: none;
            opacity: 0.15;
            transition: opacity 0.3s ease;
        }

        .watermark-item .line1 {
            color: rgba(0, 0, 0, 0.9);
            font-size: 22px;
            font-weight: 700;
            display: block;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0);
        }

        .watermark-item .line2 {
            color: rgba(0, 0, 0, 0.9);
            font-size: 15px;
            font-weight: 400;
            display: block;
            margin-top: 6px;
            letter-spacing: 0.5px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è Popup –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–ª—ë—Ç–∞ */
        .arrival-popup {
            font-family:"Montserrat", Arial, sans-serif; font-size:13px; color:#1e293b;
            min-width: 150px; text-align: center;
        }
        .arrival-popup b { display:block; margin-bottom:8px; color:#0f172a; font-size:14px; }
        .arrival-popup .metric { background: linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%); padding:8px 12px; border-radius:6px; margin:6px 0; border-left:3px solid #3b82f6; }
        .arrival-popup .metric-label { font-size:11px; color:#64748b; text-transform:uppercase; margin-bottom:4px; }
        .arrival-popup .metric-value { font-size:15px; font-weight:700; color:#1e40af; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .draw-point-marker {
            opacity: 0.8;
        }

        .stats-panel { position:absolute; top:16px; right:16px; z-index:1000; background: rgba(15,23,42,0.95); padding:16px 20px; border-radius:16px; color:#e2e8f0; min-width:200px; box-shadow:0 8px 32px rgba(0,0,0,0.4); }
        .stats-title { font-size:14px; font-weight:700; color:#60a5fa; margin-bottom:12px; }
        .stat-item { display:flex; justify-content:space-between; margin:8px 0; font-size:12px; }

        #loading { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; z-index:10000; color:#007bff; font-size:18px; font-weight:600; background:#f8f9fa; }
    </style>
</head>
<body>
    <div id="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    <div id="map"></div>

    <div class="toolbar" id="toolbar" style="display:none;">
        <div class="toolbar-header">
            <div class="toolbar-title">üéØ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <button class="secondary" id="toggleToolbar" style="padding:6px 12px; font-size:11px;">–°–≤–µ—Ä–Ω—É—Ç—å</button>
        </div>

        <div id="toolbarContent">
            <div class="toolbar-section">
                <div class="toolbar-section-title">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª–∏</div>
                <div id="spawnModeIndicator" style="font-size:12px; color:#f97316; margin-bottom:8px; display:none;">
                    –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å: <span id="currentSpawnType"></span>
                    <button class="danger" id="cancelSpawn" style="padding:4px 8px; margin-left:8px; font-size:10px;">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div class="button-group">
                    <button data-type="shakhed" id="spawnShakhedBtn">üõ©Ô∏è –®–∞—Ö–µ–¥</button>
                    <button data-type="razved" id="spawnRazvedBtn">üëÅÔ∏è –†–∞–∑–≤–µ–¥—á–∏–∫</button>
                    <button data-type="raketa" id="spawnRaketaBtn">üöÄ –†–∞–∫–µ—Ç–∞</button>
                </div>
                <div class="button-group" style="margin-top:6px;">
                    <button data-type="neizv" id="spawnNeizvBtn">‚ùì –ù–µ–∏–∑–≤.</button>
                    <button data-type="istreb" id="spawnIstrebitelBtn">‚úàÔ∏è –ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å</button>
                    <button data-type="explosion" id="spawnExplosionBtn" class="danger">üí• –î–æ–±–∞–≤–∏—Ç—å –í–∑—Ä—ã–≤</button>
                </div>
                <div style="margin-top:10px; display:flex; gap:6px; align-items:center;">
                    <input id="spawnCount" type="number" value="5" min="1" style="width:60px">
                    <button class="success" id="spawnMany">–°–æ–∑–¥–∞—Ç—å –º–Ω–æ–≥–æ –≤ —Ü–µ–Ω—Ç—Ä–µ</button>
                </div>
            </div>

            <div class="toolbar-section">
                <div class="toolbar-section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–≤–∏–∂–µ–Ω–∏—è</div>
                <label>
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á):</span>
                    <input id="speed" type="number" value="200" min="50" max="1000">
                </label>
            </div>

            <div id="bulkControls" style="display:none; margin-top:12px;">
                <div class="toolbar-section">
                    <div class="toolbar-section-title">–ú–∞—Å—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (<span id="bulkSelectedCount">0</span> —Ü–µ–ª–µ–π)</div>
                    <label style="display:block; margin-bottom:8px;">
                        <span>–£–≥–æ–ª (–≥—Ä–∞–¥):</span>
                        <input id="rotateInput" type="range" min="-180" max="180" value="0" style="width:100%; margin-top:4px;">
                        <div style="text-align:center; margin-top:8px; font-weight:600; color:#60a5fa;">
                            <span id="rotateVal">0¬∞</span>
                        </div>
                    </label>
                    <label style="margin-top:10px;">
                        <span>–ù–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á):</span>
                        <input id="newSpeed" type="number" value="200" min="50" max="1000" style="width:70px;">
                    </label>
                    <button class="success" id="applyNewSpeed" style="width:100%; margin-top:8px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å</button>
                </div>
            </div>

            <div class="toolbar-section">
                <div class="toolbar-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                <div class="button-group">
                    <button class="secondary" id="toggleSelection">üéØ –í—ã–¥–µ–ª–µ–Ω–∏–µ</button>
                    <button class="secondary" id="centerAll">üìç –¶–µ–Ω—Ç—Ä</button>
                </div>
                
                <div class="button-group" style="margin-top:6px;">
                    <button id="drawLineBtn" class="secondary">üìè –õ–∏–Ω–∏—è (–ü–æ–ª–∏–≥–æ–Ω)</button>
                    <button id="finishDrawBtn" class="success" style="display:none;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å (ENTER)</button>
                </div>
                <div class="button-group" style="margin-top:6px;">
                    <button class="danger" id="deleteAsShotDown">üóëÔ∏è –°–±–∏—Ç—Ç—è</button>
                    <button class="danger" id="deleteAsExplosion">üí• –í–∏–±—É—Ö</button>
                </div>
                <button class="secondary" id="toggleWatermark" style="margin-top:6px; width:100%">–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</button>
                <button class="success" id="screenshotBtn" style="margin-top:8px; width:100%">üì∏ –°–∫—Ä–∏–Ω –∫–∞—Ä—Ç—ã</button>
            </div>

            <div style="font-size:11px; color:#64748b; margin-top:8px; font-style:italic;">
                üí° –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî –≤—Ä–µ–º—è –ø–æ–¥–ª—ë—Ç–∞ –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Ü–µ–ª–∏.<br>
                üí° ESC ‚Äî –û—Ç–º–µ–Ω–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è.
            </div>
        </div>
    </div>

    <div class="stats-panel" id="statsPanel" style="display:none;">
        <div class="stats-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="stat-item"><span class="stat-label">–í—Å–µ–≥–æ —Ü–µ–ª–µ–π:</span><span class="stat-value" id="statTotal">0</span></div>
        <div class="stat-item"><span class="stat-label">–í—ã–±—Ä–∞–Ω–æ:</span><span class="stat-value" id="statSelected">0</span></div>
        <div class="stat-item"><span class="stat-label">–®–∞—Ö–µ–¥:</span><span class="stat-value" id="statShakhed">0</span></div>
        <div class="stat-item"><span class="stat-label">–†–∞–∑–≤–µ–¥—á–∏–∫:</span><span class="stat-value" id="statRazved">0</span></div>
        <div class="stat-item"><span class="stat-label">–†–∞–∫–µ—Ç–∞:</span><span class="stat-value" id="statRaketa">0</span></div>
    </div>

    <div class="watermark-grid" id="watermarkGrid"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script src="https://unpkg.com/leaflet-geosearch@3.10.2/dist/geosearch.umd.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map, shakheds, selected, nextId, selectionEnabled, watermarkVisible;
        let dragging = false;
        let dragStart = null;
        let initialPositions = new Map();
        let marqueeEl = null;
        let startPoint = null;
        let toolbarMinimized = false;
        let spawnMode = { active: false, type: null, icon: null }; 
        
        // –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø
        let drawMode = false;
        let linePoints = [];
        let tempMarkers = [];
        let currentLine = null;
        // –ö–û–ù–ï–¶ –ù–û–í–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–•

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const METER_PER_DEG_LAT = 111320; 
        const HISTORY_SIZE = 15; 
        const EXPLOSION_SIZE = 50; // –ò–ó–ú–ï–ù–ï–ù–û: –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∑—Ä—ã–≤–∞ (70 -> 50)

        // –ö–∞—Ä—Ç–∞ —Ç–∏–ø–æ–≤ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Å–ø–∞–≤–Ω–∞
        const unitTypes = {
            'shakhed': { icon: 'shakhed.png', name: 'üõ©Ô∏è –®–∞—Ö–µ–¥' },
            'razved': { icon: 'razved.png', name: 'üëÅÔ∏è –†–∞–∑–≤–µ–¥—á–∏–∫' },
            'raketa': { icon: 'raketa.png', name: 'üöÄ –†–∞–∫–µ—Ç–∞' },
            'neizv': { icon: 'neizv.png', name: '‚ùì –ù–µ–∏–∑–≤.' },
            'istreb': { icon: 'istreb.png', name: '‚úàÔ∏è –ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å' },
            'explosion': { icon: 'explosion.png', name: 'üí• –í–∑—Ä—ã–≤' } 
        };

        // –ñ–¥–µ–º Leaflet
        function checkLeaflet() {
            // –ñ–¥–µ–º Leaflet –∏ GeoSearch
            if (typeof L !== 'undefined' && typeof GeoSearch !== 'undefined') initMap();
            else setTimeout(checkLeaflet, 100);
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', checkLeaflet);
        else checkLeaflet();
        
        // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø
        function activateDrawMode() {
            if (spawnMode.active) deactivateSpawnMode();
            selectionEnabled = false; // –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ marquee
            
            map.getContainer().style.cursor = 'crosshair';
            drawMode = true;
            linePoints = [];
            
            tempMarkers.forEach(m => map.removeLayer(m));
            tempMarkers = [];
            
            if (currentLine) map.removeLayer(currentLine);
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é
            currentLine = L.polyline([], { color: '#f97316', weight: 3, dashArray: '8, 8' }).addTo(map);
            
            document.getElementById('drawLineBtn').classList.add('active-spawn');
            document.getElementById('finishDrawBtn').style.display = 'none';
        }

        function deactivateDrawMode() {
            map.getContainer().style.cursor = '';
            drawMode = false;
            
            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            tempMarkers.forEach(m => map.removeLayer(m));
            tempMarkers = [];
            if (currentLine) map.removeLayer(currentLine);
            currentLine = null;
            
            document.getElementById('drawLineBtn').classList.remove('active-spawn');
            document.getElementById('finishDrawBtn').style.display = 'none';
            
            selectionEnabled = true; // –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        }
        
        function addDrawPoint(latlng) {
            linePoints.push(latlng);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            const marker = L.marker(latlng, { 
                icon: L.divIcon({ 
                    className: 'draw-point-marker', 
                    html: '<div style="background:#f97316; width:10px; height:10px; border-radius:50%; border:2px solid white;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                }),
                draggable: false, 
                interactive: false 
            }).addTo(map);
            tempMarkers.push(marker);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é
            currentLine.setLatLngs(linePoints);

            if (linePoints.length >= 2) {
                document.getElementById('finishDrawBtn').style.display = 'inline-block';
            }
        }
        
        function finalizePolygon() {
            if (!drawMode || linePoints.length < 3) {
                deactivateDrawMode();
                return;
            }

            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π Polygon
            L.polygon(linePoints, {
                color: '#f97316',
                fillColor: '#f97316',
                fillOpacity: 0.3,
                weight: 3,
                interactive: true
            }).addTo(map);
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            deactivateDrawMode();
        }
        // –ö–û–ù–ï–¶ –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô

        function initMap() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('toolbar').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'block';

            shakheds = new Map();
            selected = new Set();
            nextId = 1;
            selectionEnabled = true;
            watermarkVisible = true;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            drawMode = false;
            linePoints = [];
            tempMarkers = [];
            currentLine = null;


            map = L.map('map', { zoomControl:true, dragging:true, scrollWheelZoom:true, doubleClickZoom:true, boxZoom:true }).setView([49.0,31.0],6);

            const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors', crossOrigin:'anonymous' }).addTo(map);
            
            // --- –î–û–ë–ê–í–õ–ï–ù–û: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GeoSearch ---
            const { OpenStreetMapProvider } = GeoSearch;
            const searchProvider = new OpenStreetMapProvider();
            
            const searchControl = new GeoSearch.GeoSearchControl({
                provider: searchProvider,
                style: 'bar',
                showMarker: true,
                showPopup: false,
                autoClose: true,
                retainZoomLevel: false,
                animateZoom: true,
                keepResult: true,
                autoSearch: false,
                searchLabel: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Å—Ç–æ',
            });
            
            map.addControl(searchControl);
            // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø GeoSearch ---

            // --- –î–û–ë–ê–í–õ–ï–ù–û: –ü—É—Å–∫–æ–≤—ã–µ –ª–æ–∫–∞—Ü–∏–∏ —Å –∏–∫–æ–Ω–∫–æ–π s_vpp3.png ---
            const launchLocations = [
                { name: "–®–∞—Ç–∞–ª–æ–≤–æ", lat: 54.3307, lng: 32.5032 },
                { name: "–û—Ä—ë–ª", lat: 52.9680, lng: 36.0697 },
                { name: "–ù–∞–≤–ª—è", lat: 52.8264, lng: 34.4985 },
                { name: "–ê—Å–æ–≤–∏—Ü–∞", lat: 52.3288, lng: 34.5259 },
                { name: "–•–∞–ª–∏–Ω–æ (–∞—ç—Ä–æ–ø–æ—Ä—Ç –ö—É—Ä—Å–∫)", lat: 51.7504, lng: 36.2951 },
                { name: "–ú—ñ–ª–ª–µ—Ä–æ–≤–æ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 48.9226, lng: 40.2927 },
                { name: "–®–∞—Ö—Ç—ã", lat: 47.7086, lng: 40.2156 },
                { name: "–ü—Ä–∏–º–æ—Ä—Å—å–∫–æ-–ê—Ö—Ç–∞—Ä—Å—å–∫ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 46.0467, lng: 38.2140 },
                { name: "–ï–π—Å—å–∫ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 46.6831, lng: 38.2169 },
                { name: "–ß–∞—É–¥–∞ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 45.0558, lng: 35.3185 },
                { name: "–ì–≤–∞—Ä–¥—ñ–π—Å—å–∫–µ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 45.0612, lng: 33.9753 },
                { name: "–ö–∞—á–∞ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 44.7804, lng: 33.5450 },
                { name: "–ë–∞–ª–∞–∫–ª–∞–≤–∞", lat: 44.5004, lng: 33.5995 },
                { name: "–î–æ–Ω–µ—Ü—å–∫ (–∞—ç—Ä–æ–ø–æ—Ä—Ç)", lat: 48.0736, lng: 37.7394 },
                { name: "–ú–∞–∫—ñ—ó–≤–∫–∞", lat: 48.0479, lng: 37.9253 },
                { name: "–ë–µ—Ä–¥—è–Ω—Å—å–∫ (–∞—ç—Ä–æ–¥—Ä–æ–º)", lat: 46.8141, lng: 36.7582 }
            ];

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –ø—É—Å–∫–æ–≤—ã—Ö
            const launchIcon = L.icon({
                iconUrl: 's_vpp3.png', // –ò–º—è —Ñ–∞–π–ª–∞, –∫–∞–∫ –≤—ã –∏ –ø—Ä–æ—Å–∏–ª–∏
                iconSize: [24, 24],    // –ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–ú–´–ô –†–ê–ó–ú–ï–† (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
                iconAnchor: [12, 12],  // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏
                popupAnchor: [0, -12]  // –°–º–µ—â–µ–Ω–∏–µ popup
            });

            // –î–æ–±–∞–≤–ª—è–µ–º L.marker
            launchLocations.forEach(loc => {
                L.marker([loc.lat, loc.lng], { icon: launchIcon })
                    .addTo(map)
                    .bindPopup(`<b>${loc.name}</b><br>${loc.lat}, ${loc.lng}`);
            });
            // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
            
            const grid = document.getElementById('watermarkGrid');

            // --- –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ (–ü'—è—Ç–∏—Ö–∞—Ç–æ–∫) ---
            function createWatermarks() {
                grid.innerHTML = '';
                const cols = Math.ceil(window.innerWidth / 220);
                const rows = Math.ceil(window.innerHeight / 140);
                const total = Math.max(1, cols * rows);
                for (let i = 0; i < total; i++) {
                    const item = document.createElement('div');
                    item.className = 'watermark-item';
                    const line1 = document.createElement('span');
                    line1.className = 'line1';
                    line1.textContent = '–ë—É–ª—å–¥–æ–∂–∫–∏–Ω';
                    const line2 = document.createElement('span');
                    line2.className = 'line2';
                    line2.textContent = '@Buldoshkin_monitor'; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π —Ö–µ–Ω–¥–ª
                    item.appendChild(line1);
                    item.appendChild(line2);
                    grid.appendChild(item);
                }
            }

            createWatermarks();
            window.addEventListener('resize', () => { if (watermarkVisible) createWatermarks(); });

            document.getElementById('toggleWatermark').addEventListener('click', ()=> {
                watermarkVisible = !watermarkVisible;
                grid.style.display = watermarkVisible ? 'grid' : 'none';
            });
            
            // --- Helper –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
            function proxyImgUrl(url){
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL –ª–æ–∫–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, explosion.png)
                    if (!/^https?:\/\//i.test(url)) return url; 

                    const u = new URL(url, location.href);
                    const hostPath = u.host + u.pathname + (u.search || '');
                    return 'https://images.weserv.nl/?url=' + encodeURIComponent(hostPath);
                } catch(e){ return url; }
            }
            function loadImage(url){
                return new Promise((resolve,reject)=>{
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = ()=>resolve(img);
                    img.onerror = ()=>reject(new Error('img load error '+url));
                    img.src = url;
                });
            }

            // –°–ö–†–ò–ù: –∫–Ω–æ–ø–∫–∞ –∏ –ª–æ–≥–∏–∫–∞
            document.getElementById('screenshotBtn').addEventListener('click', async ()=>{
                const toolbar = document.getElementById('toolbar');
                const stats = document.getElementById('statsPanel');
                const mapEl = map.getContainer();

                const hideEls = [toolbar, stats];
                hideEls.forEach(el=>{ if (el) el.style.visibility = 'hidden'; });

                await new Promise(r=>setTimeout(r, 120));

                try {
                    const rect = mapEl.getBoundingClientRect();
                    const canvas = document.createElement('canvas');
                    canvas.width = Math.round(rect.width);
                    canvas.height = Math.round(rect.height);
                    const ctx = canvas.getContext('2d');
                    
                    const tileSize = 256;
                    const z = map.getZoom();
                    const pixelBounds = map.getPixelBounds();
                    const minTileX = Math.floor(pixelBounds.min.x / tileSize);
                    const maxTileX = Math.floor((pixelBounds.max.x) / tileSize);
                    const minTileY = Math.floor(pixelBounds.min.y / tileSize);
                    const maxTileY = Math.floor((pixelBounds.max.y) / tileSize);

                    // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–π–ª–æ–≤ –∫–∞—Ä—Ç—ã
                    const tilePromises = [];
                    for (let tx = minTileX; tx <= maxTileX; tx++){
                        for (let ty = minTileY; ty <= maxTileY; ty++){
                            const s = ['a','b','c'][Math.abs(tx+ty)%3];
                            const tileUrl = `https://${s}.tile.openstreetmap.org/${z}/${tx}/${ty}.png`;
                            const prox = proxyImgUrl(tileUrl);
                            const px = Math.round(tx*tileSize - pixelBounds.min.x);
                            const py = Math.round(ty*tileSize - pixelBounds.min.y);
                            const p = loadImage(prox).then(img=>({img, x:px, y:py})).catch(err=>({err, x:px, y:py}));
                            tilePromises.push(p);
                        }
                    }

                    const tiles = await Promise.all(tilePromises);
                    for (const t of tiles){
                        if (t && t.img) ctx.drawImage(t.img, t.x, t.y, tileSize, tileSize);
                        else { ctx.fillStyle = '#ececec'; ctx.fillRect(t.x, t.y, tileSize, tileSize); }
                    }

                    // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞—Ç–µ—Ä–º–∞—Ä–æ–∫
                    ctx.globalAlpha = 0.15;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const stepX = 220, stepY = 140, pad = 40;
                    for (let x = pad; x < canvas.width; x += stepX){
                        for (let y = pad; y < canvas.height; y += stepY){
                            ctx.fillStyle = 'rgba(0,0,0,0.9)';
                            ctx.font = '700 22px Montserrat, Arial';
                            ctx.fillText('–†–∞–¥–∞—Ä –ë—É–ª—å–¥–æ–∂–∏–Ω–∞', x, y - 6);
                            ctx.font = '400 15px Montserrat, Arial';
                            ctx.fillText('@Buldoshkin_monitot', x, y + 16);
                        }
                    }
                    ctx.globalAlpha = 1.0;

                    // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–π (—Ö–≤–æ—Å—Ç–æ–≤)
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);

                    for (const [id, s] of shakheds) {
                        if (s.type === 'explosion') continue; // –í–∑—Ä—ã–≤—ã –±–µ–∑ —Ö–≤–æ—Å—Ç–æ–≤
                        if (s.history && s.history.length > 1) {
                            const screenPoints = s.history.map(latlng => map.latLngToContainerPoint(latlng));
                            
                            ctx.beginPath();
                            screenPoints.forEach((pt, index) => {
                                if (index === 0) {
                                    ctx.moveTo(pt.x, pt.y);
                                } else {
                                    ctx.lineTo(pt.x, pt.y);
                                }
                            });
                            ctx.stroke();
                        }
                    }
                    ctx.setLineDash([]); 

                    // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ú–∞—Ä–∫–µ—Ä–æ–≤ (–¶–µ–ª–µ–π)
                    const markerPromises = [];
                    for (const [id,s] of shakheds){
                        try{
                            const pt = map.latLngToContainerPoint(s.latlng);
                            
                            // –ü–æ–ª—É—á–∞–µ–º URL –∏–∫–æ–Ω–∫–∏
                            let iconUrl = '';
                            if (s.type === 'explosion') {
                                iconUrl = unitTypes.explosion.icon;
                            } else {
                                const imgEl = s.el.querySelector('img');
                                if (imgEl) iconUrl = imgEl.src;
                            }
                            
                            if (s.type === 'explosion') {
                                markerPromises.push(Promise.resolve({ isExplosion: true, pt, size: EXPLOSION_SIZE, url: iconUrl }));
                                continue;
                            }
                            
                            if (iconUrl) {
                                const prox = proxyImgUrl(iconUrl);
                                const pr = loadImage(prox).then(img=>({img, pt, angle: s.angle})).catch(err=>({err, pt}));
                                markerPromises.push(pr);
                            }
                            
                        }catch(e){/* skip */}
                    }
                    
                    const markers = await Promise.all(markerPromises);
                    for (const m of markers){
                        if (m.isExplosion) {
                            const w = m.size, h = m.size;
                            const x = m.pt.x, y = m.pt.y;

                            // –ó–∞–≥—Ä—É–∂–∞–µ–º PNG –¥–ª—è –≤–∑—Ä—ã–≤–∞
                            const img = await loadImage(m.url).catch(()=>null); 
                            
                            if (img) {
                                ctx.save();
                                // PNG –≤–∑—Ä—ã–≤–∞
                                ctx.drawImage(img, x - w/2, y - h/2, w, h);
                                ctx.restore();
                            } else {
                                // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (—Å—Ç–∞—Ä—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç)
                                ctx.save();
                                const gradient = ctx.createRadialGradient(x, y, 0, x, y, w/2);
                                gradient.addColorStop(0, 'rgba(252,165,165,1)');
                                gradient.addColorStop(0.7, 'rgba(239,68,68,0)');
                                ctx.fillStyle = gradient;
                                ctx.globalAlpha = 0.9;
                                ctx.beginPath();
                                ctx.arc(x, y, w/2, 0, 2 * Math.PI);
                                ctx.fill();
                                ctx.restore();
                            }
                        } else if (m && m.img){
                            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¶–µ–ª–∏
                            const w = m.img.width, h = m.img.height;
                            const ptX = m.pt.x, ptY = m.pt.y;
                            
                            ctx.save();
                            ctx.translate(ptX, ptY);
                            ctx.rotate(m.angle * Math.PI/180);
                            ctx.drawImage(m.img, -w/2, -h/2, w, h);
                            ctx.restore();
                        }
                    }

                    // 5. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ü–æ–ª–∏–≥–æ–Ω–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                    // TODO: –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø–æ–ª–∏–≥–æ–Ω—ã, –∏—Ö –Ω—É–∂–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–¥–µ—Å—å.
                    
                    // 6. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    if (!blob) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å blob –∏–∑ canvas.');

                    try {
                        if (navigator.clipboard && navigator.clipboard.write) {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            alert('–°–∫—Ä–∏–Ω —Å –∫–∞—Ä—Ç–æ–π –∏ —Ü–µ–ª—è–º–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                        } else {
                            const url = URL.createObjectURL(blob);
                            window.open(url, '_blank');
                            alert('–ë—É—Ñ–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –æ—Ç–∫—Ä—ã—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é)');
                        }
                    } catch (err) {
                        const url = URL.createObjectURL(blob);
                        window.open(url, '_blank');
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä: ' + (err && err.message ? err.message : err) + '–û—Ç–∫—Ä—ã—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.');
                    }

                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω–∞: ' + (e && e.message ? e.message : e));
                }

                hideEls.forEach(el=>{ if (el) el.style.visibility = ''; });
            });


            // --- –ì–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ ---
            function getDistance(latlng1, latlng2) {
                const R = 6371; // –∫–º
                const dLat = (latlng2.lat - latlng1.lat) * (Math.PI / 180);
                const dLon = (latlng2.lng - latlng1.lng) * (Math.PI / 180);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(latlng1.lat * (Math.PI / 180)) * Math.cos(latlng2.lat * (Math.PI / 180)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; // –∫–º
            }

            // --- –ò–Ω–¥–∏–∫–∞—Ü–∏—è TOA (Popup) ---
            map.on('dblclick', function(e) {
                if (spawnMode.active || drawMode) return;
                
                let closest = null;
                let minTime = Infinity;
                let minDistance = Infinity;

                for (const [id, s] of shakheds) {
                    if (s.type === 'explosion') continue;
                    
                    const speedKmh = s.speed * 3.6;
                    const distanceKm = getDistance(e.latlng, s.latlng);
                    const timeHours = distanceKm / speedKmh;

                    if (timeHours < minTime) {
                        minTime = timeHours;
                        minDistance = distanceKm;
                        closest = s;
                    }
                }

                if (closest) {
                    const timeMinutes = (minTime * 60).toFixed(1);
                    const distanceKm = minDistance.toFixed(1);

                    const content = `
                        <div class="arrival-popup">
                            <b>‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–¥–ª—ë—Ç–∞ –¥–æ —Ü–µ–ª–∏</b>
                            <div class="metric">
                                <span class="metric-label">–ë–ª–∏–∂–∞–π—à–∞—è —Ü–µ–ª—å:</span>
                                <span class="metric-value">#${closest.id} (${closest.type})</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–í—Ä–µ–º—è:</span>
                                <span class="metric-value">${timeMinutes} –º–∏–Ω</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</span>
                                <span class="metric-value">${distanceKm} –∫–º</span>
                            </div>
                        </div>
                    `;
                    L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
                } else if (shakheds.size > 0) {
                    L.popup().setLatLng(e.latlng).setContent('–ù–µ—Ç –¥–≤–∏–∂—É—â–∏—Ö—Å—è —Ü–µ–ª–µ–π.').openOn(map);
                } else {
                    L.popup().setLatLng(e.latlng).setContent('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π.').openOn(map);
                }
            });


            // --- –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Å–ø–∞–≤–Ω–∞ ---
            function activateSpawnMode(type) {
                if (drawMode) deactivateDrawMode(); // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
                
                spawnMode.active = true;
                spawnMode.type = type;
                spawnMode.icon = unitTypes[type].icon;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('spawnModeIndicator').style.display = 'block';
                document.getElementById('currentSpawnType').textContent = unitTypes[type].name;
                
                document.querySelectorAll('.toolbar button[data-type]').forEach(btn => btn.classList.remove('active-spawn'));
                document.querySelector(`.toolbar button[data-type="${type}"]`).classList.add('active-spawn');
                
                map.getContainer().style.cursor = 'crosshair';
            }
            
            // --- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å–ø–∞–≤–Ω–∞ ---
            function deactivateSpawnMode() {
                spawnMode.active = false;
                spawnMode.type = null;
                spawnMode.icon = null;
                
                document.getElementById('spawnModeIndicator').style.display = 'none';
                document.querySelectorAll('.toolbar button[data-type]').forEach(btn => btn.classList.remove('active-spawn'));
                map.getContainer().style.cursor = drawMode ? 'crosshair' : '';
            }
            
            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –≤ —Ä–µ–∂–∏–º–µ —Å–ø–∞–≤–Ω–∞ / —Ä–∏—Å–æ–≤–∞–Ω–∏—è ---
            map.on('click', function(e) {
                if (spawnMode.active) {
                    if (spawnMode.type === 'explosion') {
                        spawnExplosion(e.latlng);
                        deactivateSpawnMode(); 
                    } else {
                        spawnUnit(e.latlng, spawnMode.icon, 0, defaultSpeed());
                        deactivateSpawnMode(); 
                    }
                } else if (drawMode) { // <--- –ù–û–í–´–ô –•–ï–ù–î–õ–ï–† –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø
                    addDrawPoint(e.latlng);
                }
            });
            
            document.getElementById('cancelSpawn').addEventListener('click', deactivateSpawnMode);
            
            // --- –•–ï–ù–î–õ–ï–†–´ –ö–ù–û–ü–û–ö –†–ò–°–û–í–ê–ù–ò–Ø ---
            document.getElementById('drawLineBtn').addEventListener('click', ()=>{
                if (drawMode) deactivateDrawMode(); else activateDrawMode();
            });
            document.getElementById('finishDrawBtn').addEventListener('click', finalizePolygon);
            
            // --- –•–ï–ù–î–õ–ï–† –ö–õ–ê–í–ò–®–ò ENTER/ESCAPE ---
            document.addEventListener('keydown', function(e) {
                if (drawMode) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        finalizePolygon();
                    } else if (e.key === 'Escape') {
                        e.preventDefault(); 
                        deactivateDrawMode();
                    }
                }
            });


            // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            function updateStats() {
                const types = { 'shakhed':0, 'razved':0, 'raketa':0, 'neizv':0, 'istreb':0 };
                let totalMoving = 0;
                for (const [id, s] of shakheds) { 
                    if (types[s.type] !== undefined) {
                        types[s.type]++; 
                        totalMoving++;
                    }
                }
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–í—Å–µ–≥–æ —Ü–µ–ª–µ–π" —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–≤–∏–∂—É—â–∏–µ—Å—è, –∫–∞–∫ –≤ –≤–∞—à–µ–º —Å–∫—Ä–∏–ø—Ç–µ
                document.getElementById('statTotal').textContent = totalMoving; 
                document.getElementById('statSelected').textContent = selected.size;
                document.getElementById('statShakhed').textContent = types['shakhed'] || 0;
                document.getElementById('statRazved').textContent = types['razved'] || 0;
                document.getElementById('statRaketa').textContent = types['raketa'] || 0;
                
                syncBulkControls(); 
            }

            // —Å–∫–æ—Ä–æ—Å—Ç—å: input –≤ –∫–º/—á -> –º/—Å
            const defaultSpeed = () => (Number(document.getElementById('speed').value) || 200) / 3.6;


            /* ---------- –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π ---------- */
            function applyElapsed(elapsedSeconds) {
                if (!elapsedSeconds || elapsedSeconds <= 0) return;
                for (const [id, s] of shakheds) {
                    if (s.type === 'explosion') continue; 
                    
                    const dx = s.vx * elapsedSeconds; 
                    const dy = s.vy * elapsedSeconds; 

                    const METER_PER_DEG_LNG = (40075000 * Math.cos(s.latlng.lat * Math.PI / 180) / 360);

                    const deltaLat = dy / METER_PER_DEG_LAT;
                    const deltaLng = dx / METER_PER_DEG_LNG;

                    s.latlng = L.latLng(s.latlng.lat + deltaLat, s.latlng.lng + deltaLng);
                    s.marker.setLatLng(s.latlng);
                    
                    s.history.push(s.latlng.clone());
                    if (s.history.length > HISTORY_SIZE) s.history.shift(); 
                    
                    s.polyline.setLatLngs(s.history);
                }
            }

            let lastTime = performance.now();
            function rafLoop(time) {
                const elapsed = (time - lastTime) / 1000;
                lastTime = time;

                applyElapsed(elapsed);

                requestAnimationFrame(rafLoop);
            }
            requestAnimationFrame(rafLoop);

            /* ---------- –ú–∞—Ä–∫–µ—Ä—ã, —Å–ø–∞–≤–Ω, UI ---------- */
            
            // =======================================================
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞, 
            // —á—Ç–æ–±—ã –º–∞—Ä–∫–µ—Ä—ã –Ω–µ "–ø—Ä—ã–≥–∞–ª–∏" –ø—Ä–∏ –∑—É–º–µ
            // =======================================================
            function makeMarkerElement(id, imgSrc, type) {
                const isExplosion = type === 'explosion';
                
                // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ë–ê–ó–û–í–´–ô —Ä–∞–∑–º–µ—Ä (CSS —Ä–∞–∑–º–µ—Ä)
                const baseIconSize = isExplosion ? [EXPLOSION_SIZE, EXPLOSION_SIZE] : [50, 35];
                
                // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç –≤—ã–ø–∏—Ä–∞–µ—Ç –∏–∑-–∑–∞ —Ä—É—á–∫–∏
                //    (7px –∏–∑-–∑–∞ 'right: -7px' –Ω–∞ —Ä—É—á–∫–µ 14px)
                const handleSpillover = isExplosion ? 0 : 7;

                // 3. –†–∞–∑–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø–µ—Ä–µ–¥–∞–¥–∏–º –≤ L.divIcon
                //    (–±–∞–∑–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ + "–≤—ã–ø–∏—Ä–∞–Ω–∏–µ")
                const leafletIconSize = [baseIconSize[0] + handleSpillover, baseIconSize[1]];

                // 4. –Ø–∫–æ—Ä—å (anchor) - —ç—Ç–æ –í–°–ï–ì–î–ê —Ü–µ–Ω—Ç—Ä *–±–∞–∑–æ–≤–æ–≥–æ* —Ä–∞–∑–º–µ—Ä–∞,
                //    —á—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∞ –±—ã–ª–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É. –û–∫—Ä—É–≥–ª—è–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å 1px "–¥—Ä–∏—Ñ—Ç–∞".
                const leafletIconAnchor = [
                    Math.round(baseIconSize[0] / 2), 
                    Math.round(baseIconSize[1] / 2)
                ]; // [25, 18] –¥–ª—è —é–Ω–∏—Ç–∞, [25, 25] –¥–ª—è –≤–∑—Ä—ã–≤–∞

                // –°–æ–∑–¥–∞–µ–º wrap
                const wrap = L.DomUtil.create('div','marker-wrap'); 
                wrap.dataset.id = id;
                wrap.dataset.type = type; 
                
                // 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS-—Ä–∞–∑–º–µ—Ä (–æ–Ω –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, 50x35 –∏–ª–∏ 50x50)
                wrap.style.width = `${baseIconSize[0]}px`;
                wrap.style.height = `${baseIconSize[1]}px`;

                if (isExplosion) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSS –∫–ª–∞—Å—Å –¥–ª—è PNG
                    L.DomUtil.create('div', 'explosion-icon', wrap);
                } else {
                    const imgClass = type === 'razved' ? 'razved-icon'
                                    : type === 'raketa' ? 'raketa-icon'
                                    : type === 'neizv' ? 'neizv-icon'
                                    : type === 'istreb' ? 'istreb-icon'
                                    : 'shakhed-icon';
                    L.DomUtil.create('img', imgClass, wrap).src = imgSrc;
                }
                
                const border = L.DomUtil.create('div','marker-border',wrap);
                const handle = L.DomUtil.create('div','rotate-handle',wrap);

                L.DomEvent.on(border,'click', ev=>{
                    L.DomEvent.stopPropagation(ev);
                    if (!selectionEnabled) return; 
                    const id = Number(wrap.dataset.id);
                    if (ev.shiftKey) toggleSelect(id); else { clearSelection(); selectId(id); }
                });

                if (!isExplosion) {
                    handle.addEventListener('mousedown', ev=> startDrag(ev, id, true)); 
                    border.addEventListener('mousedown', ev=> { if (ev.button === 0) startDrag(ev, id, false); });
                }
                
                border.addEventListener('contextmenu', ev=>{ ev.preventDefault(); ev.stopPropagation(); });

                // 6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è Leaflet
                return { 
                    el: wrap, 
                    iconSize: leafletIconSize, // [57, 57]
                    iconAnchor: leafletIconAnchor // [25, 18]
                };
            }

            /* --- –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í–ó–†–´–í–ê --- */
            function spawnExplosion(latlng) {
                const id = nextId++;
                const type = 'explosion';
                // makeMarkerElement —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ [50, 50] / [25, 25]
                const { el, iconSize, iconAnchor } = makeMarkerElement(id, unitTypes.explosion.icon, type);
                const icon = L.divIcon({ className:'', html:el, iconSize:iconSize, iconAnchor:iconAnchor });
                const marker = L.marker(latlng, { icon, interactive:true, draggable:false }).addTo(map);

                shakheds.set(id, { id, marker, el, latlng: L.latLng(latlng), type });
                
                // –í–∑—Ä—ã–≤ –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(()=>{
                    const s = shakheds.get(id);
                    if(s) { map.removeLayer(s.marker); shakheds.delete(id); updateStats(); }
                }, 5000); 

                updateStats(); 
            }
            
            /* --- –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –¶–ï–õ–ò --- */
            function deleteUnit(id) {
                 const s = shakheds.get(id);
                 if (s) { 
                    map.removeLayer(s.marker); 
                    if (s.polyline) map.removeLayer(s.polyline); 
                    shakheds.delete(id); selected.delete(id); 
                    updateStats();
                 }
            }


            function spawnUnit(latlng, imgSrc, angleDeg, speed) {
                const id = nextId++;
                const type = Object.keys(unitTypes).find(k => unitTypes[k].icon === imgSrc);
                // makeMarkerElement —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [57, 35] / [25, 18]
                const { el, iconSize, iconAnchor } = makeMarkerElement(id, imgSrc, type);
                const icon = L.divIcon({ className:'', html:el, iconSize:iconSize, iconAnchor:iconAnchor });
                const marker = L.marker(latlng, { icon, interactive:true, draggable:false }).addTo(map);
                
                const polyline = L.polyline([], { color: '#3b82f6', weight: 2, dashArray: '5, 5', opacity: 0.7 }).addTo(map);

                const unit = { id, marker, el, latlng: L.latLng(latlng), angle: angleDeg, speed: speed || defaultSpeed(), vx:0, vy:0, type, polyline, history: [] }; 
                shakheds.set(id, unit);
                
                setAngleForId(id, angleDeg, false); 
                
                updateMarkerTransform(id);
                updateStats();
                return id;
            }
            
            // (–í–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤–∞—à–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞)
            function setVelocityForId(id, angle, speed, updateInput=true){
                const s = shakheds.get(id); if (!s) return;
                s.angle = angle;
                s.speed = speed;
                
                const rad = angle * Math.PI / 180;
                s.vx = -Math.cos(rad) * s.speed;
                s.vy = Math.sin(rad) * s.speed;
                
                updateMarkerTransform(id); 
                if(updateInput) syncBulkControls();
            }

            // (–£–ø—Ä–æ—â–µ–Ω–æ)
            function setAngleForId(id, angle, updateInput=true) {
                const s = shakheds.get(id); if (!s) return;
                setVelocityForId(id, angle, s.speed, updateInput);
            }
            
            function setSpeedForId(id, speed) {
                const s = shakheds.get(id); if (!s) return;
                setVelocityForId(id, s.angle, speed);
            }

            function updateMarkerTransform(id) {
                const s = shakheds.get(id); if (!s) return;
                s.el.style.transform = `rotate(${s.angle}deg)`;
                if (selected.has(id)) s.el.classList.add('marker-selected'); else s.el.classList.remove('marker-selected');
            }
            
            let isRotating = false;

            function startDrag(ev, id, isRotationMode) {
                if (ev.button !== 0 || drawMode) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                L.DomEvent.stop(ev);
                
                isRotating = isRotationMode;

                if (!selected.has(id)) clearSelection();
                selectId(id);
                
                dragging = true;
                dragStart = { x: ev.clientX, y: ev.clientY };
                initialPositions.clear();
                selected.forEach(selId => {
                    const s = shakheds.get(selId);
                    if (s && s.type !== 'explosion') { // –í–∑—Ä—ã–≤—ã –Ω–µ –¥–≤–∏–≥–∞—é—Ç—Å—è
                        initialPositions.set(selId, { 
                            lat: s.latlng.lat, 
                            lng: s.latlng.lng,
                            initialAngle: s.angle,
                        });
                    }
                });
                document.body.style.cursor = isRotating ? 'crosshair' : 'grabbing';
            }

            function onDrag(ev) {
                if (!dragging) return;
                L.DomEvent.stop(ev);

                if (isRotating) {
                    const centerId = selected.values().next().value;
                    const centerS = shakheds.get(centerId);
                    if (!centerS) return;

                    const centerPt = map.latLngToContainerPoint(centerS.latlng);
                    const dx = ev.clientX - centerPt.x;
                    const dy = ev.clientY - centerPt.y;
                    
                    const angleRad = Math.atan2(dy, dx);
                    let angleDeg = angleRad * (180 / Math.PI) + 180;
                    if (angleDeg > 180) angleDeg -= 360;
                    
                    for(const id of selected){
                        setAngleForId(id, angleDeg, false);
                    }
                    syncBulkControls();


                } else {
                    const dx = ev.clientX - dragStart.x;
                    const dy = ev.clientY - dragStart.y;
                    initialPositions.forEach((pos, id) => {
                        const s = shakheds.get(id); if (!s) return;
                        const startPt = map.latLngToContainerPoint({lat: pos.lat, lng: pos.lng});
                        const newPt = L.point(startPt.x + dx, startPt.y + dy);
                        s.latlng = map.containerPointToLatLng(newPt);
                        s.marker.setLatLng(s.latlng);
                        
                        // –°–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏, —á—Ç–æ–±—ã —Ö–≤–æ—Å—Ç –Ω–µ –ø—Ä—ã–≥–∞–ª
                        s.history = [s.latlng.clone()];
                        s.polyline.setLatLngs(s.history);
                    });
                }
            }

            function endDrag() { 
                dragging=false; 
                dragStart=null; 
                initialPositions.clear(); 
                document.body.style.cursor=''; 
                isRotating = false;
            }

            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', endDrag);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ touch-—Å–æ–±—ã—Ç–∏–π (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –≤–∫–ª—é—á–∞—è Safari)
            // Leaflet —Ö–æ—Ä–æ—à–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç touch –¥–ª—è drag –∏ zoom, –Ω–æ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–∞—à–µ–π –ª–æ–≥–∏–∫–∏.
            map.getContainer().addEventListener('touchstart', (e) => {
                if (drawMode) return;
                
                // –ï—Å–ª–∏ –∫–æ—Å–Ω—É–ª–∏—Å—å –º–∞—Ä–∫–µ—Ä–∞, –Ω–∞—á–∏–Ω–∞–µ–º drag (Leaflet'–æ–≤—Å–∫–∏–π touch drag)
                const targetMarkerWrap = e.target.closest('.marker-wrap');
                if (targetMarkerWrap && selectionEnabled) {
                    const id = Number(targetMarkerWrap.dataset.id);
                    if (id && shakheds.get(id).type !== 'explosion') {
                        // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ drag (–¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è)
                        startDrag(e.touches[0], id, false);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º touchmove/touchend
                        const onTouchMove = (evt) => onDrag(evt.touches[0]);
                        const onTouchEnd = () => {
                            endDrag();
                            map.getContainer().removeEventListener('touchmove', onTouchMove);
                            map.getContainer().removeEventListener('touchend', onTouchEnd);
                        };
                        
                        map.getContainer().addEventListener('touchmove', onTouchMove, { passive: false });
                        map.getContainer().addEventListener('touchend', onTouchEnd);
                        
                        L.DomEvent.stop(e);
                    }
                }
            }, { passive: false });


            function clearSelection(){ for (const id of Array.from(selected)) deselectId(id); }
            // –í—ã–±–∏—Ä–∞—Ç—å –º–æ–∂–Ω–æ –≤—Å–µ, –∫—Ä–æ–º–µ "–≤–∑—Ä—ã–≤–∞"
            function selectId(id){ const s = shakheds.get(id); if(s && s.type === 'explosion') return; selected.add(id); updateMarkerTransform(id); syncBulkControls(); updateStats(); }
            function deselectId(id){ selected.delete(id); updateMarkerTransform(id); syncBulkControls(); updateStats(); }
            function toggleSelect(id){ if (selected.has(id)) deselectId(id); else selectId(id); }

            /* ---------- UI handlers ---------- */
            document.getElementById('toggleSelection').addEventListener('click', ()=>{ selectionEnabled = !selectionEnabled; if(!selectionEnabled) clearSelection(); document.getElementById('toggleSelection').style.opacity = selectionEnabled ? '1' : '0.6'; });
            document.getElementById('toggleToolbar').addEventListener('click', ()=>{
                toolbarMinimized = !toolbarMinimized;
                const content = document.getElementById('toolbarContent');
                const btn = document.getElementById('toggleToolbar');
                const toolbar = document.getElementById('toolbar');
                if (toolbarMinimized) { content.style.display='none'; btn.textContent='–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å'; toolbar.classList.add('minimized'); }
                else { content.style.display='block'; btn.textContent='–°–≤–µ—Ä–Ω—É—Ç—å'; toolbar.classList.remove('minimized'); }
            });

            /* ---------- spawn buttons (–û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∫–ª–∏–∫–∞) ---------- */
            document.querySelectorAll('.toolbar button[data-type]').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.dataset.type;
                    deactivateSpawnMode(); 
                    activateSpawnMode(type);
                });
            });
            

            document.getElementById('spawnMany').addEventListener('click', ()=>{
                deactivateSpawnMode(); 
                const n = Math.max(1, Number(document.getElementById('spawnCount').value) || 5);
                const center = map.getCenter();
                const types = [unitTypes.shakhed.icon, unitTypes.razved.icon, unitTypes.raketa.icon, unitTypes.neizv.icon, unitTypes.istreb.icon];
                for (let i=0;i<n;i++){
                    const jitter = (Math.random()-0.5)*0.8;
                    const angle = (Math.random()*360)-180;
                    const randomType = types[Math.floor(Math.random()*types.length)];
                    spawnUnit([center.lat + jitter/2, center.lng + jitter], randomType, angle, defaultSpeed());
                }
            });

            /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø --- */
            // 1. –°–±–∏—Ç—Ç—è (–ø—Ä–æ—Å—Ç–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
            document.getElementById('deleteAsShotDown').addEventListener('click', ()=>{
                for (const id of Array.from(selected)) {
                    deleteUnit(id); 
                }
                syncBulkControls(); updateStats();
            });

            // 2. –í–∏–±—É—Ö (—É–¥–∞–ª–µ–Ω–∏–µ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∑—Ä—ã–≤–∞)
            document.getElementById('deleteAsExplosion').addEventListener('click', ()=>{
                if (selected.size === 0) return;

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–≤–æ–π —Ü–µ–ª–∏ –¥–ª—è –≤–∑—Ä—ã–≤–∞
                const firstSelectedId = Array.from(selected).find(id => shakheds.get(id)?.type !== 'explosion');
                const firstUnit = shakheds.get(firstSelectedId);
                
                if (firstUnit) {
                    spawnExplosion(firstUnit.latlng);
                }

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏
                for (const id of Array.from(selected)) {
                    deleteUnit(id); 
                }

                syncBulkControls(); updateStats();
            });


            document.getElementById('centerAll').addEventListener('click', ()=>{
                const arr = Array.from(shakheds.values()).map(s=>s.latlng).filter(l => l);
                if (arr.length) map.fitBounds(L.latLngBounds(arr), { maxZoom:12, padding:[50,50] });
            });

            /* ---------- bulk controls UI ---------- */
            const bulkControls = document.getElementById('bulkControls');
            const rotateInput = document.getElementById('rotateInput');
            const rotateVal = document.getElementById('rotateVal');
            const newSpeedInput = document.getElementById('newSpeed');
            const bulkSelectedCount = document.getElementById('bulkSelectedCount');

            rotateInput.addEventListener('input', ()=>{
                const val = Number(rotateInput.value); 
                rotateVal.textContent = val + '¬∞';
                for (const id of selected) setAngleForId(id, val, false);
            });
            
            document.getElementById('applyNewSpeed').addEventListener('click', ()=>{
                const newSpeedKmh = Number(newSpeedInput.value);
                const newSpeedMs = newSpeedKmh / 3.6;
                for (const id of selected) setSpeedForId(id, newSpeedMs);
            });

            function syncBulkControls(){
                // –¢–æ–ª—å–∫–æ –¥–≤–∏–∂—É—â–∏–µ—Å—è —Ü–µ–ª–∏ (–Ω–µ –≤–∑—Ä—ã–≤—ã) —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                const movingSelected = Array.from(selected).filter(id => shakheds.get(id)?.type !== 'explosion');
                
                if (movingSelected.length === 0) { bulkControls.style.display='none'; return; }
                
                bulkControls.style.display='block';
                bulkSelectedCount.textContent = selected.size; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —á–∏—Å–ª–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                
                let sum=0,count=0;
                for (const id of movingSelected){ 
                    const s = shakheds.get(id); 
                    sum+=s.angle; count++; 
                }
                const avg = count>0 ? Math.round(sum/count) : 0;
                rotateInput.value = avg; rotateVal.textContent = avg + '¬∞';
                
                const firstId = movingSelected[0];
                const firstS = shakheds.get(firstId);
                const firstSpeedKmh = firstS ? Math.round(firstS.speed * 3.6) : 200;
                newSpeedInput.value = firstSpeedKmh;
            }

            /* ---------- marquee selection ---------- */
            map.getContainer().addEventListener('mousedown', function(ev){
                if (ev.button !== 0 || isRotating || !selectionEnabled || spawnMode.active || drawMode) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                if (ev.target.closest('.toolbar') || ev.target.closest('.stats-panel') || ev.target.closest('.marker-wrap')) return;

                startPoint = { x:ev.clientX, y:ev.clientY };
                
                if(!ev.shiftKey) clearSelection();

                marqueeEl = document.createElement('div'); 
                marqueeEl.className = 'marquee';
                marqueeEl.style.left = `${startPoint.x}px`;
                marqueeEl.style.top = `${startPoint.y}px`;
                document.body.appendChild(marqueeEl);
                
                const onMarqueeMove = (e) => {
                    if (!marqueeEl) return;
                    const currentX = e.clientX, currentY = e.clientY;
                    const x = Math.min(startPoint.x, currentX);
                    const y = Math.min(startPoint.y, currentY);
                    const w = Math.abs(startPoint.x - currentX);
                    const h = Math.abs(startPoint.y - currentY);
                    
                    marqueeEl.style.left = `${x}px`;
                    marqueeEl.style.top = `${y}px`;
                    marqueeEl.style.width = `${w}px`;
                    marqueeEl.style.height = `${h}px`;
                    
                    const marqueeRect = { x: x, y: y, xMax: x + w, yMax: y + h };

                    shakheds.forEach(s => {
                        // –í–∑—Ä—ã–≤—ã —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–¥–µ–ª–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è, –Ω–æ –Ω–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≥–ª–æ–º/—Å–∫–æ—Ä–æ—Å—Ç—å—é.
                        // Marquee –¥–æ–ª–∂–µ–Ω –≤—ã–¥–µ–ª—è—Ç—å –≤—Å–µ.
                        
                        const markerPt = map.latLngToContainerPoint(s.latlng);
                        const isInside = markerPt.x >= marqueeRect.x && markerPt.x <= marqueeRect.xMax && 
                                         markerPt.y >= marqueeRect.y && markerPt.y <= marqueeRect.yMax;
                        
                        if (isInside) { 
                             // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ selected, —á—Ç–æ–±—ã –≤–∑—Ä—ã–≤—ã —Ç–æ–∂–µ –≤—ã–¥–µ–ª—è–ª–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                             selected.add(s.id); 
                             updateMarkerTransform(s.id);
                             syncBulkControls(); 
                             updateStats();
                        } else if (!ev.shiftKey) { 
                             // –ï—Å–ª–∏ –Ω–µ –∑–∞–∂–∞—Ç Shift, —Ç–æ —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —Ç–µ—Ö, –∫—Ç–æ –≤—ã—à–µ–ª
                             selected.delete(s.id); 
                             updateMarkerTransform(s.id); 
                        }
                    });
                };
                
                const onMarqueeUp = () => {
                    if (marqueeEl) {
                        marqueeEl.remove(); 
                        marqueeEl = null;
                    }
                    window.removeEventListener('mousemove', onMarqueeMove);
                    window.removeEventListener('mouseup', onMarqueeUp);
                    startPoint = null;
                    syncBulkControls(); 
                    updateStats();
                };

                window.addEventListener('mousemove', onMarqueeMove);
                window.addEventListener('mouseup', onMarqueeUp);
            });
        }
    </script>
</body>
</html>