<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Radar Tracking System v2 - Icons Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100vw; }

        #ui-layer {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(10, 20, 30, 0.9); padding: 15px; border-radius: 8px;
            border: 1px solid #00ffff; color: #00ffff; width: 240px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        input { width: 100%; padding: 8px; margin: 5px 0; background: #111; border: 1px solid #00ffff; color: #00ff00; box-sizing: border-box; }
        button { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; background: #003344; color: #00ffff; border: 1px solid #00ffff; font-weight: bold; text-transform: uppercase; }
        
        .controls-hint { font-size: 11px; color: #00cccc; margin-top: 10px; border-top: 1px solid #003344; padding-top: 10px; line-height: 1.6; }
        .key { color: #fff; font-weight: bold; border-bottom: 1px solid #00ffff; }

        #history-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(10, 20, 30, 0.9); padding: 10px 25px;
            border-radius: 4px; border: 1px solid #00ffff; width: 50%;
            display: flex; flex-direction: column; align-items: center;
        }
        #history-slider { width: 100%; cursor: pointer; accent-color: #00ffff; }
        #time-display { color: #00ffff; font-family: monospace; font-size: 14px; margin-bottom: 4px; font-weight: bold; }

        /* СТИЛИ ДЛЯ ИКОНОК */
        .target-icon { 
            transition: transform 0.2s linear; 
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
        }
        .detected-glow { 
            filter: drop-shadow(0 0 10px #ffff00) brightness(1.2) !important; 
        }
        
        .label { 
            font-size: 10px; font-weight: bold;
            background: rgba(0, 0, 0, 0.85); 
            padding: 2px 5px; border: 1px solid; 
            margin-top: 2px; white-space: nowrap;
            pointer-events: auto; border-radius: 2px;
            text-transform: uppercase; text-align: center;
        }

        .radar-scanner { width: 40px; height: 40px; background: conic-gradient(from 0deg, rgba(0, 255, 255, 0.3), transparent 90deg); border-radius: 50%; animation: scan 4s linear infinite; }
        @keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="auth-box">
        <input type="text" id="nick" placeholder="ИМЯ ОПЕРАТОРА">
        <input type="password" id="pass" placeholder="ПАРОЛЬ">
        <button onclick="app.login()">ЗАПУСК СИСТЕМЫ</button>
    </div>
    <div id="user-box" style="display:none">
        <b id="user-display"></b>
        <div class="controls-hint">
            <span class="key">1-5</span> Карта | <span class="key">E/Q/R</span> Пуск<br>
            <span class="key">G</span> РАДАР | <span class="key">F</span> Управление
        </div>
    </div>
</div>

<div id="history-panel" style="display:none">
    <div id="time-display">SYSTEM LIVE</div>
    <input type="range" id="history-slider" min="0" max="600" value="600">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const layers = {
    "1": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    "2": L.tileLayer('http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'),
    "3": L.tileLayer('http://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}'),
    "5": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
};

const app = {
    user: null, targets: {}, radars: {}, map: null, currentLayer: null,
    isDrawing: false, isFMode: false, currentCapturedId: null, 
    startPoint: null, tempMarker: null, mousePos: {lat:0, lng:0}, currentType: null,
    historyOffset: 0,
    iconPaths: {
        shahed: 'icons/shakhed.png',
        razvedka: 'icons/razved.png'
    },

    init() {
        this.map = L.map('map', { zoomControl: false }).setView([50.45, 30.52], 7);
        this.currentLayer = layers["5"];
        this.currentLayer.addTo(this.map);

        this.map.on('mousemove', e => {
            this.mousePos = e.latlng;
            if (this.isDrawing) this.updateTempIcon();
            if (this.isFMode && this.currentCapturedId) this.updateCapturedRotation();
        });

        document.getElementById('history-slider').addEventListener('input', e => {
            this.historyOffset = 600 - parseInt(e.target.value);
            this.updateTimeLabel();
        });

        window.addEventListener('keydown', e => this.handleKeys(e));
        window.addEventListener('keyup', e => {
            const k = e.key.toLowerCase();
            if (this.isDrawing && ['e','q','r','у','й','к'].includes(k)) this.stopDraw();
        });

        this.startAnimation();
        setInterval(() => this.recordHistory(), 1000);
    },

    login() {
        const nick = document.getElementById('nick').value.trim();
        if (!nick) return;
        this.user = nick;
        document.getElementById('auth-box').style.display = 'none';
        document.getElementById('user-box').style.display = 'block';
        document.getElementById('history-panel').style.display = 'flex';
        document.getElementById('user-display').innerText = "ОПЕРАТОР: " + this.user;
    },

    updateTimeLabel() {
        const el = document.getElementById('time-display');
        if (this.historyOffset === 0) { el.innerText = "SYSTEM LIVE"; el.style.color = "#00ffff"; }
        else { el.innerText = "АРХИВ: -" + this.historyOffset + "s"; el.style.color = "#ffff00"; }
    },

    handleKeys(e) {
        const key = e.key.toLowerCase();
        if (layers[e.key]) {
            this.map.removeLayer(this.currentLayer);
            this.currentLayer = layers[e.key];
            this.currentLayer.addTo(this.map);
            return;
        }
        if (!this.user) return;
        if (key === 'f' || key === 'а') {
            this.isFMode = !this.isFMode;
            if (!this.isFMode) this.releaseCapture();
            return;
        }
        if (key === 'g' || key === 'п') return this.addRadar();
        if (this.isDrawing || this.isFMode) return;
        if (['e','q','у','й'].includes(key)) this.startDraw('shahed');
        else if (['r','к'].includes(key)) this.startDraw('razvedka');
    },

    addRadar() {
        L.circle([this.mousePos.lat, this.mousePos.lng], {radius: 7000, color: '#00ffff', weight: 1, fillOpacity: 0.1, dashArray: '5, 10'}).addTo(this.map);
        const icon = L.divIcon({ className: '', html: '<div class="radar-scanner"></div>', iconSize: [0,0] });
        L.marker([this.mousePos.lat, this.mousePos.lng], {icon}).addTo(this.map);
        this.radars[Date.now()] = { lat: this.mousePos.lat, lng: this.mousePos.lng, radius: 7000 };
    },

    startDraw(type) {
        this.isDrawing = true; this.currentType = type; this.startPoint = this.mousePos;
        const icon = L.divIcon({
            className: 'marker-container',
            html: `<img src="${this.iconPaths[type]}" id="temp-icon" style="width: 35px; height: 35px; opacity: 0.6">`,
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });
        this.tempMarker = L.marker([this.startPoint.lat, this.startPoint.lng], {icon}).addTo(this.map);
    },

    updateTempIcon() {
        const p1 = this.map.latLngToContainerPoint(this.startPoint);
        const p2 = this.map.latLngToContainerPoint(this.mousePos);
        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI) + 90;
        const el = document.getElementById('temp-icon');
        if(el) el.style.transform = `rotate(${angle}deg)`;
    },

    stopDraw() {
        const p1 = this.map.latLngToContainerPoint(this.startPoint);
        const p2 = this.map.latLngToContainerPoint(this.mousePos);
        const angleRad = Math.atan2(p2.y - p1.y, p2.x - p1.x);
        const id = 't' + Math.random().toString(36).substr(2, 5);
        this.targets[id] = {
            type: this.currentType, lat: this.startPoint.lat, lng: this.startPoint.lng,
            angleRad: angleRad, startTime: Date.now(), 
            speed: this.currentType === 'shahed' ? 140/3600 : 100/3600, history: []
        };
        this.createMarker(id, this.targets[id]);
        this.map.removeLayer(this.tempMarker);
        this.isDrawing = false;
    },

    createMarker(id, data) {
        const color = data.type === 'shahed' ? '#ff3333' : '#33ff33';
        const html = `
            <div style="display: flex; flex-direction: column; align-items: center; width: 60px;">
                <img src="${this.iconPaths[data.type]}" id="img-${id}" class="target-icon" style="width: 35px; height: 35px;">
                <div class="label" id="lab-${id}" style="border-color: ${color}; color: ${color}">${data.type}</div>
            </div>
        `;
        const icon = L.divIcon({
            className: '',
            html: html,
            iconSize: [60, 60],
            iconAnchor: [30, 17]
        });
        data.marker = L.marker([data.lat, data.lng], {icon}).addTo(this.map);
        data.marker.on('mouseover', () => { if (this.isFMode) this.currentCapturedId = id; });
        data.marker.on('click', () => { if(!this.isFMode) { this.map.removeLayer(data.marker); delete this.targets[id]; } });
    },

    updateCapturedRotation() {
        const t = this.targets[this.currentCapturedId];
        const p1 = this.map.latLngToContainerPoint(t.marker.getLatLng());
        const p2 = this.map.latLngToContainerPoint(this.mousePos);
        t.angleRad = Math.atan2(p2.y - p1.y, p2.x - p1.x);
    },

    releaseCapture() {
        if (this.currentCapturedId && this.targets[this.currentCapturedId]) {
            const t = this.targets[this.currentCapturedId];
            const pos = t.marker.getLatLng();
            t.lat = pos.lat; t.lng = pos.lng; t.startTime = Date.now();
        }
        this.currentCapturedId = null;
    },

    recordHistory() {
        const now = Date.now();
        for (let id in this.targets) {
            const t = this.targets[id];
            const pos = t.marker.getLatLng();
            t.history.push({ t: now, lat: pos.lat, lng: pos.lng, ang: t.angleRad });
            if (t.history.length > 600) t.history.shift();
        }
    },

    startAnimation() {
        const loop = () => {
            const now = Date.now();
            const viewTime = now - (this.historyOffset * 1000);

            for (let id in this.targets) {
                const t = this.targets[id];
                let dLat, dLng, dAng, isPast = this.historyOffset > 0;

                if (isPast) {
                    const pt = t.history.reduce((p, c) => Math.abs(c.t - viewTime) < Math.abs(p.t - viewTime) ? c : p, t.history[0] || null);
                    if (pt) { dLat = pt.lat; dLng = pt.lng; dAng = pt.ang; }
                } else {
                    if (this.isFMode && this.currentCapturedId === id) {
                        dLat = t.marker.getLatLng().lat; dLng = t.marker.getLatLng().lng; dAng = t.angleRad;
                    } else {
                        const elapsed = (now - t.startTime) / 1000;
                        const dist = t.speed * elapsed;
                        dLat = t.lat + (dist * Math.sin(t.angleRad)) / -111;
                        dLng = t.lng + (dist * Math.cos(t.angleRad)) / (111 * Math.cos(t.lat * Math.PI / 180));
                        dAng = t.angleRad;
                    }
                }

                if (dLat) {
                    t.marker.setLatLng([dLat, dLng]);
                    const img = document.getElementById(`img-${id}`);
                    const lab = document.getElementById(`lab-${id}`);
                    if (img) {
                        img.style.transform = `rotate(${(dAng * 180 / Math.PI) + 90}deg)`;
                        img.style.opacity = isPast ? "0.4" : "1";
                        
                        let det = false;
                        for (let rid in this.radars) {
                            if (this.map.distance([dLat, dLng], [this.radars[rid].lat, this.radars[rid].lng]) < 7000) det = true;
                        }
                        
                        const baseCol = t.type === 'shahed' ? '#ff3333' : '#33ff33';
                        if (det) {
                            img.classList.add('detected-glow');
                            lab.style.borderColor = '#ffff00';
                            lab.style.color = '#ffff00';
                            lab.innerText = t.type + " [DET]";
                        } else {
                            img.classList.remove('detected-glow');
                            lab.style.borderColor = baseCol;
                            lab.style.color = baseCol;
                            lab.innerText = t.type;
                        }
                    }
                }
            }
            requestAnimationFrame(loop);
        };
        loop();
    }
};
app.init();
</script>
</body>
</html>